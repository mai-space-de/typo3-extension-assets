name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ---------------------------------------------------------------------------
  # Validate composer.json
  # ---------------------------------------------------------------------------
  composer-validate:
    name: Composer validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          coverage: none

      - name: Validate composer.json
        run: composer validate --strict

  # ---------------------------------------------------------------------------
  # Unit tests (PHP 8.1 / 8.2 / 8.3 × TYPO3 12.4 / 13.4)
  # ---------------------------------------------------------------------------
  unit-tests:
    name: "Unit tests · PHP ${{ matrix.php }} · TYPO3 ${{ matrix.typo3 }}"
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        php: ["8.1", "8.2", "8.3"]
        typo3: ["^12.4", "^13.4"]
        exclude:
          # TYPO3 13.4 requires PHP 8.2+
          - php: "8.1"
            typo3: "^13.4"

    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: gd, intl, mbstring, xml
          coverage: none
          tools: composer:v2

      # Pin the TYPO3 core version before installing so Composer picks the
      # right constraint when both 12 and 13 satisfy `^12.4 || ^13.4`.
      - name: Pin TYPO3 version
        run: composer require --no-update "typo3/cms-core:${{ matrix.typo3 }}"

      - name: Install dependencies
        run: >
          composer install
          --prefer-dist
          --no-progress
          --no-interaction
        env:
          COMPOSER_ROOT_VERSION: "1.0.0"

      - name: Run unit tests
        run: vendor/bin/phpunit --configuration phpunit.xml.dist --testdox

  # ---------------------------------------------------------------------------
  # Static analysis
  # ---------------------------------------------------------------------------
  static-analysis:
    name: PHPStan
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          extensions: gd, intl, mbstring, xml
          coverage: none
          tools: composer:v2

      - name: Install dependencies
        run: >
          composer install
          --prefer-dist
          --no-progress
          --no-interaction
        env:
          COMPOSER_ROOT_VERSION: "1.0.0"

      - name: Run PHPStan
        run: vendor/bin/phpstan analyse --no-progress
        # Allow the job to fail without blocking the overall CI status until the
        # baseline is established. Remove `continue-on-error` once clean.
        continue-on-error: true

  # ---------------------------------------------------------------------------
  # Code style
  # ---------------------------------------------------------------------------
  code-style:
    name: PHP-CS-Fixer
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          coverage: none
          tools: composer:v2

      - name: Install dependencies
        run: >
          composer install
          --prefer-dist
          --no-progress
          --no-interaction
        env:
          COMPOSER_ROOT_VERSION: "1.0.0"

      - name: Check code style
        run: vendor/bin/php-cs-fixer check --no-interaction --diff
        # Allow the job to fail without blocking the overall CI status until the
        # CS config is finalized. Remove `continue-on-error` once clean.
        continue-on-error: true
